[gcode_macro MMU_RECOVER_LOADED]
gcode:
    {% set loaded = params.LOADED|default(1)|int %}
    MMU_RECOVER LOADED={loaded}

[gcode_macro MMU_SET_STATE]
description: Schaltet die MMU ein (1) oder aus (0)
gcode:
    {% set state = params.STATE|default(1)|int %}
    
    {% if state == 1 %}
        MMU_ENABLE ENABLE=1
        { action_respond_info("MMU wurde AKTIVIERT.") }
    {% elif state == 0 %}
        MMU_ENABLE ENABLE=0
        { action_respond_info("MMU wurde DEAKTIVIERT.") }
    {% else %}
        { action_raise_error("Ungültiger Status: Nutze STATE=0 oder STATE=1") }
    {% endif %}
    
#####################################################################
# Gate Parking
#####################################################################
[gcode_macro TEST_GATE_PARKING_FULL]
gcode:
    {% set gate = params.GATE|default(0)|int %}
    
    M117 Lade Gate {gate} bis zum Toolhead-Sensor...
    MMU_SELECT GATE={gate}
    
    # Lädt das Filament bis zum Sensor vor der Düse. 
    # Durch 'TERMINATING_STATUS=mmu_toolhead' stoppt er dort und 
    # versucht nicht, in die (kalte) Düse zu extrudieren.
    MMU_LOAD TERMINATING_STATUS=mmu_toolhead
    
    G4 P2000 # 2 Sekunden warten, damit du die Position am Sensor prüfen kannst
    
    M117 Entlade zum Parken...
    # Hier greifen jetzt deine Einstellungen für 'gate_unload_buffer' 
    # und 'gate_parking_distance'
    MMU_UNLOAD
    
    M117 Fertig! Position im Gate prüfen.

#####################################################################
# Toolchange Temperatur
#####################################################################
[gcode_macro MMU_TOOLCHANGE_TEMP]
variable_temp_pla: 215
variable_temp_petg: 210
gcode:
    # Leer lassen
[gcode_macro TOOLCHANGE_TEMP_PLA]
gcode:
    {% set temp = params.VALUE|default(215)|int %}
    SET_GCODE_VARIABLE MACRO=MMU_TOOLCHANGE_TEMP VARIABLE=temp_pla VALUE={temp}
    M117 PLA Toolchange Temp: {temp}C

[gcode_macro TOOLCHANGE_TEMP_PETG]
gcode:
    {% set temp = params.VALUE|default(230)|int %}
    SET_GCODE_VARIABLE MACRO=MMU_TOOLCHANGE_TEMP VARIABLE=temp_petg VALUE={temp}
    M117 PETG Toolchange Temp: {temp}C

[gcode_macro CHECK_MMU_TEMPS]
gcode:
    {% set pla = printer["gcode_macro MMU_TOOLCHANGE_TEMP"].temp_pla %}
    {% set petg = printer["gcode_macro MMU_TOOLCHANGE_TEMP"].temp_petg %}
    { action_respond_info("Aktuelle MMU Toolchange Temperaturen:
                           PLA:  %s°C
                           PETG: %s°C" % (pla, petg)) }

[gcode_macro APPLY_MMU_TEMP_PLA]
gcode:
    {% set t = printer["gcode_macro MMU_TOOLCHANGE_TEMP"].temp_pla %}
    SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=toolchange_temp VALUE={t}
    M117 MMU: PLA Temp {t}C aktiv

[gcode_macro APPLY_MMU_TEMP_PETG]
gcode:
    {% set t = printer["gcode_macro MMU_TOOLCHANGE_TEMP"].temp_petg %}
    SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=toolchange_temp VALUE={t}
    M117 MMU: PETG Temp {t}C aktiv

#####################################################################
# Materialabhängiges TIP-FORMING
#####################################################################

[gcode_macro _SET_MATERIAL_VARS]
description: Setzt Tip-Forming Parameter basierend auf Material (PETG, PLA oder DEFAULT)
gcode:
    {% set MATERIAL = params.MATERIAL|default("UNKNOWN")|upper %}
    
    {% if MATERIAL == "PETG" %}
        {action_respond_info("MMU: PETG Profil wird geladen...")}
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=ramming_volume VALUE=4
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=toolchange_temp VALUE=210
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=unloading_speed_start VALUE=800
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=unloading_speed VALUE=20
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=cooling_tube_position VALUE=30
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=cooling_moves VALUE=6
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=initial_cooling_speed VALUE=10
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=final_cooling_speed VALUE=150
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=use_skinnydip VALUE=True
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=skinnydip_distance VALUE=25
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=dip_extraction_speed VALUE=400
        {action_respond_info("MMU: PETG Profil aktiv!")}

    {% elif MATERIAL == "PLA" %}
        {action_respond_info("MMU: PLA Profil wird geladen...")}
        # Hier kommen spaeter deine optimierten PLA-Werte rein
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=ramming_volume VALUE=4
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=toolchange_temp VALUE=215
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=unloading_speed_start VALUE=800
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=unloading_speed VALUE=20
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=cooling_moves VALUE=6
        # ... restliche PLA Werte ...
        {action_respond_info("MMU: PLA Profil aktiv!")}

    {% else %}
        {action_respond_info("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")}
        {action_respond_info("WARNUNG: Material '" ~ MATERIAL ~ "' ist unbekannt!")}
        {action_respond_info("Lade DEFAULT Sicherheits-Profil (Konservative Werte)")}
        {action_respond_info("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")}
        # Visueller Alarm: Frame Light aus und an (simulierter Blink-Effekt)
        Frame_Light_OFF
        G4 P500
        Frame_Light_ON
        
        # Konservative DEFAULT-Werte (kein Skinnydip, viel Kühlung)
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=ramming_volume VALUE=0
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=toolchange_temp VALUE=0 # Behaelt aktuelle Temp
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=use_skinnydip VALUE=False
        SET_GCODE_VARIABLE MACRO=_MMU_FORM_TIP_VARS VARIABLE=cooling_moves VALUE=10
    {% endif %}