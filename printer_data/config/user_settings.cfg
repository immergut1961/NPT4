#############################################################################
    #   PI Pico
#############################################################################
    
[mcu pico]
serial: /dev/serial/by-id/usb-Klipper_rp2040_50443405A02C8F1C-if00

#############################################################################
    #   NFC Reader Pi Pico über I2C und Bridge angebunden
#############################################################################
    
# === NFC2Klipper Bridge ===
[serial_bridge]
serial: /dev/nfc_reader
baud: 115200

# --- Shell Command: NFC Timer ---
[gcode_shell_command nfc_wait_for_gate]
command: /usr/local/bin/wait_for_gate {spool_id}
timeout: 30.0
verbose: True

# --- Makro: NFC-Tag gelesen ---
[gcode_macro SET_SPOOL_ID]
gcode:
  {% if 'ID=' in rawparams %}
    {% set spool_id = rawparams.split('ID=')[1] | string %}
    {action_respond_info("NFC: SpoolID %s erkannt – 20s Timer startet!" % spool_id)}
    RUN_SHELL_COMMAND CMD=nfc_wait_for_gate PARAMS=spool_id="{spool_id}"
  {% endif %}

#############################################################################
    
[gcode_macro PRINT_END]
gcode:
    Frame_Light_OFF
    Part_Light_OFF
    M400                    ; wait for buffer to clear
    TURN_OFF_HEATERS
    G92 E0                  ; zero the extruder
    #G91                     ; Relative positioning
    #G1 E-4 F2700            ; Retract a bit
    #G1 X5 Y5 Z4 F3000          ; Wipe out
    #G1 E-3 Z4 F3000       ; Retract and raise Z
    # G1 Z4 F3000  
     {% if printer.toolhead.position.z <165 %}
    G90 ; use absolute coordinates
    G1 Z170 F3000
    {% else %}
    G91                     ; Relative positioning
    G1 Z5 F3000
    {% endif %}           ; Raise Z more
    G90                     ; Absolute positioning
    G1 X280            ; Present print
    M107                    ; turn off fan
    M84                     ; turn off steppers
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
    M117
    END_TUNE                ; Print End Beeper Jingle

[input_shaper]
shaper_type_x = 2hump_ei
shaper_freq_x = 73.2
shaper_type_y = mzv
shaper_freq_y = 37.0

#############################################################################
#   USER SETTINGS & OPTIMIZATIONS
#############################################################################

# 1. Intelligente Lüftersteuerung (reagiert auf Rockchip-Temperatur)
[temperature_fan mainboard_fan]
pin: PC7
sensor_type: temperature_host
control: watermark
target_temp: 45.0
min_temp: 10
max_temp: 80
max_speed: 1.0
min_speed: 0.3

# 2. Optimiertes Bed Mesh (CPU-Entlastung für flüssigeren Datenstrom)
[bed_mesh]
speed: 150
horizontal_move_z: 5
mesh_min: 10, 21
mesh_max: 300.75, 315.45
probe_count: 11, 11
algorithm: bicubic
bicubic_tension: 0.2
mesh_pps: 2, 2
fade_start: 1.0
fade_end: 10.0

# 3. Optimiertes PRINT_START Makro mit Sicherheits-Pausen für MMU/Mesh
[gcode_macro PRINT_START]
gcode:
    Frame_Light_ON
    Part_Light_ON
    G92 E0
    G90
    BED_MESH_CLEAR
    
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set BED_HEAT_SOAK_MINUTES = params.BED_HEAT_SOAK_MINUTES|default(0)|float %}
    {% set BED_MESH = params.BED_MESH|default('adaptive')|string %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}
    
    M104 S140   ; Vorheizen Extruder
    SET_BED_TEMPERATURE TARGET={BED_TEMP}
    BED_TEMPERATURE_WAIT MINIMUM={BED_TEMP-2} MAXIMUM={BED_TEMP+4}
    
    {% if BED_HEAT_SOAK_MINUTES > 0 %}
    RESPOND MSG="Waiting {BED_HEAT_SOAK_MINUTES} minutes for the bed to settle."
    G4 P{BED_HEAT_SOAK_MINUTES * 60000}
    {% endif %}
    
    CG28
    
    {% if BED_MESH == 'full' %}
    BED_MESH_CALIBRATE
    {% elif BED_MESH == 'adaptive' %}
    BED_MESH_CALIBRATE ADAPTIVE=1
    {% elif BED_MESH != 'none' %}
    BED_MESH_PROFILE LOAD={BED_MESH}
    {% endif %}

    # Sicherheits-Puffer für den flush_handler
    M400
    G4 P500
    
    Smart_Park
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={EXTRUDER_TEMP}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={EXTRUDER_TEMP-4} MAXIMUM={EXTRUDER_TEMP+10}

    # Puffer vor Skew-Berechnung
    M400
    SKEW_PROFILE LOAD=skew_profile_1
    G4 P200