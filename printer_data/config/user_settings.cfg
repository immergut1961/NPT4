#############################################################################
    #   PI Pico
#############################################################################
    
[mcu pico]
serial: /dev/serial/by-id/usb-Klipper_rp2040_50443405A02C8F1C-if00

#############################################################################
    #   NFC Reader Pi Pico über I2C und Bridge angebunden
#############################################################################
    
# === NFC2Klipper Bridge ===
[serial_bridge]
serial: /dev/nfc_reader
baud: 115200

# --- Shell Command: NFC Timer ---
[gcode_shell_command nfc_wait_for_gate]
command: /usr/local/bin/wait_for_gate {spool_id}
timeout: 30.0
verbose: True

# --- Makro: NFC-Tag gelesen ---
[gcode_macro SET_SPOOL_ID]
gcode:
  {% if 'ID=' in rawparams %}
    {% set spool_id = rawparams.split('ID=')[1] | string %}
    {action_respond_info("NFC: SpoolID %s erkannt – 20s Timer startet!" % spool_id)}
    RUN_SHELL_COMMAND CMD=nfc_wait_for_gate PARAMS=spool_id="{spool_id}"
  {% endif %}


[input_shaper]
shaper_type_x = 2hump_ei
shaper_freq_x = 73.2
shaper_type_y = mzv
shaper_freq_y = 37.0

#############################################################################
#   USER SETTINGS & OPTIMIZATIONS
#############################################################################

# 1. Intelligente Lüftersteuerung des Mainboardlüfters (reagiert auf Rockchip-Temperatur)
[temperature_fan mainboard_fan]
pin: PC7
sensor_type: temperature_host
control: watermark
target_temp: 49.0
min_temp: 10
max_temp: 80
max_speed: 1.0
min_speed: 0.3

# 1.1 weitere Lüfter
[fan]   ; Bauteillüfter Extruder
pin: PB7

# 2. Optimiertes Bed Mesh (CPU-Entlastung für flüssigeren Datenstrom)
[bed_mesh]
speed: 150
horizontal_move_z: 5
mesh_min: 10, 21
mesh_max: 300.75, 315.45
probe_count: 11, 11
algorithm: bicubic
bicubic_tension: 0.2
mesh_pps: 2, 2
fade_start: 1.0
fade_end: 10.0

# 3. Optimiertes PRINT_START Makro mit Sicherheits-Pausen für MMU/Mesh
[gcode_macro PRINT_START]
gcode:
    # --- SICHERHEITS-RESET AM ANFANG ---
    SET_GCODE_OFFSET Z=0 MOVE=1
    
    SET_GCODE_VARIABLE MACRO=SHUTDOWN_NACH_DRUCK_VORMERKEN VARIABLE=status VALUE=0
    Frame_Light_ON
    Part_Light_ON
    G92 E0
    G90
    BED_MESH_CLEAR
    
    # --- PARAMETER ABGREIFEN ---
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set BED_HEAT_SOAK_MINUTES = params.BED_HEAT_SOAK_MINUTES|default(0)|float %}
    {% set BED_MESH = params.BED_MESH|default('adaptive')|string %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}
    {% set PLATE_TYPE = params.PLATE_TYPE|default("High Temp Plate")|string %}
    # NEU: Material-Typ vom Slicer empfangen
    {% set MATERIAL = params.MATERIAL|default("UNKNOWN")|string %}
    
    # --- MATERIAL-PROFIL LADEN (NEU) ---
    _SET_MATERIAL_VARS MATERIAL={MATERIAL}
    M400        ; Warten bis Variablen gesetzt sind
    
    # --- Z-OFFSET LOGIK ---
    {% if PLATE_TYPE == "Textured PEI Plate" %}
        SET_GCODE_OFFSET Z=0.11
        { action_respond_info("Z-OFFSET: Textured PEI erkannt. Versatz +0.11mm") }
    {% else %}
        SET_GCODE_OFFSET Z=0.0
        { action_respond_info("Z-OFFSET: Standard/High Temp erkannt. Versatz 0.00mm") }
    {% endif %}
    
    M104 S140   ; Vorheizen Extruder
    SET_BED_TEMPERATURE TARGET={BED_TEMP}
    BED_TEMPERATURE_WAIT MINIMUM={BED_TEMP-2} MAXIMUM={BED_TEMP+4}
    
    {% if BED_HEAT_SOAK_MINUTES > 0 %}
    RESPOND MSG="Waiting {BED_HEAT_SOAK_MINUTES} minutes for the bed to settle."
    G4 P{BED_HEAT_SOAK_MINUTES * 60000}
    {% endif %}
    
    CG28
    
    {% if BED_MESH == 'full' %}
    BED_MESH_CALIBRATE
    {% elif BED_MESH == 'adaptive' %}
    BED_MESH_CALIBRATE ADAPTIVE=1
    {% elif BED_MESH != 'none' %}
    BED_MESH_PROFILE LOAD={BED_MESH}
    {% endif %}

    # Sicherheits-Puffer für den flush_handler
    M400
    G4 P500
    
    Smart_Park
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={EXTRUDER_TEMP}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={EXTRUDER_TEMP-4} MAXIMUM={EXTRUDER_TEMP+10}

    # Puffer vor Skew-Berechnung
    M400
    SKEW_PROFILE LOAD=skew_profile_1
    G4 P200

[gcode_macro PRINT_END]
gcode:
    # --- Z-OFFSET RESET ---
    SET_GCODE_OFFSET Z=0 MOVE=1    ; Löscht alle temporären Offsets (Platte + Filament)
    
    Frame_Light_OFF
    Part_Light_OFF
    M400                    ; wait for buffer to clear
    TURN_OFF_HEATERS
    M106 S255               ; Bauteillüfter auf 100% zur schnellen Abkühlung
    M117 Kuehle ab...
    G92 E0                  ; zero the extruder
    
    {% if printer.toolhead.position.z < 165 %}
        G90 ; use absolute coordinates
        G1 Z170 F3000
    {% else %}
        G91                     ; Relative positioning
        G1 Z5 F3000
    {% endif %}           ; Raise Z more
    
    G90                     ; Absolute positioning
    G1 X280 F3000           ; Present print (X280 für bequeme Entnahme)
    M84                     ; turn off steppers
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
    M106 S255               ; Bauteillüfter auf volle Kraft
    M117 Schnelle Abkuehlung...
    
    # Warte, bis das Hotend unter 120°C gefallen ist
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=120
    
    M107                    ; Lüfter aus, sobald 100°C erreicht sind
    M117 Sicher abgekuehlt.
    END_TUNE                ; Print End Beeper Jingle

    # --- AB HIER: AUTOMATISCHER SHUTDOWN CHECK ---
    CHECK_SHUTDOWN_CONDITION

#####################################################################
# Tasmota Power-Management & Shutdown (Verschmolzene Logik)
#####################################################################

[gcode_shell_command tasmota_timer]
# Setzt den Tasmota-Countdown: Wartet 60s (Delay 600) und schaltet dann aus (Power1 0)
command: curl "http://192.168.2.253/cm?cmnd=Backlog%20Delay%20600%3B%20Power1%200"
timeout: 5.0
verbose: True

[gcode_macro SHUTDOWN_NACH_DRUCK_VORMERKEN]
description: 1 = Aktiviert (Nach Druck AUS), 0 = Deaktiviert (Drucker bleibt AN)
variable_status: 0
gcode:
    {% set s = params.STATUS|default(1)|int %}
    SET_GCODE_VARIABLE MACRO=SHUTDOWN_NACH_DRUCK_VORMERKEN VARIABLE=status VALUE={s}
    
    {% if s == 1 %}
        M117 Shutdown vorgemerkt!
        {action_respond_info("AUTOMATIK: Shutdown wurde VORGEMERKT und wird nach END_PRINT ausgeführt.")}
    {% else %}
        M117 Shutdown deaktiviert
        {action_respond_info("AUTOMATIK: Vormerkung aufgehoben. Drucker bleibt AN.")}
    {% endif %}

[gcode_macro CHECK_SHUTDOWN_CONDITION]
description: Wird im END_PRINT aufgerufen - prüft ob abgeschaltet werden soll
gcode:
    {% set auto_off = printer["gcode_macro SHUTDOWN_NACH_DRUCK_VORMERKEN"].status %}

    {% if auto_off == 1 %}
        {action_respond_info("Shutdown-Vormerkung erkannt. Starte Sicherheits-Abkühlung...")}
        # Status für den nächsten Start zurücksetzen
        SET_GCODE_VARIABLE MACRO=SHUTDOWN_NACH_DRUCK_VORMERKEN VARIABLE=status VALUE=0
        _EXECUTE_AUTO_SHUTDOWN
    {% else %}
        {action_respond_info("Keine Vormerkung. Drucker bleibt im Standby.")}
    {% endif %}

[gcode_macro SHUTDOWN_AND_OFF]
description: Sofortiger Shutdown (nur im Standby möglich)
gcode:
    {% if printer.idle_timeout.state == "Printing" %}
        {action_respond_info("Abbruch: Drucker druckt! Nutze 'SHUTDOWN_NACH_DRUCK_VORMERKEN' mit Wert 1.")}
    {% else %}
        _EXECUTE_AUTO_SHUTDOWN
    {% endif %}

[gcode_macro _EXECUTE_AUTO_SHUTDOWN]
description: Internes Makro für den eigentlichen Shutdown-Prozess
gcode:
    # 1. Heizungen sicherheitshalber ausschalten
    M104 S0
    M140 S0
    
    # 2. Intelligente Temperatur-Prüfung
    {% if printer.extruder.temperature > 120 %}
        M117 Heiß! Abkühlen auf 120°C...
        {action_respond_info("Extruder bei %.1f°C. Warte auf Abkühlung..." % printer.extruder.temperature)}
        TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=120
    {% else %}
        M117 Kalt genug (%.1f°C).
        {action_respond_info("Extruder bereits kühl genug.")}
    {% endif %}
    
    # 3. Tasmota Timer starten
    M117 Timer an Tasmota...
    RUN_SHELL_COMMAND CMD=tasmota_timer
    
    # 4. Kleiner Puffer für Netzwerkbefehl
    G4 P5000 
    
    # 5. Pi / Board herunterfahren
    M117 System-Shutdown...
    {action_respond_info("Sende Shutdown-Befehl an das Betriebssystem...")}
    UPDATE_DELAYED_GCODE ID=delayed_shutdown DURATION=1

[delayed_gcode delayed_shutdown]
gcode:
    {action_call_remote_method("shutdown_machine")}